<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= title %>
  </title>
  <link rel="stylesheet" href="/styles/globle.css">
  <link rel="stylesheet" href="/styles/index.css">
</head>

<body>

  <div class="mainContent">
    <header>
      <nav>
        <h1>File Uploader</h1>
        <div class="flexWrap">
          <% if (user) { %>
            Logged in as <%= user.username %>
              <a href="/auth/logout">Log Out</a>
              <% } else { %>
                Not logged in
                <a href="/auth/login">Log In</a>
                <% } %>

        </div>
      </nav>
    </header>
    <aside>
      <h2>Upload an Image</h2>
      <div class="newEntityBox">
        <button class="newEntity" id="openFilePopup">New File</button>
        <button class="newEntity" id="openFolderPopup">New Folder</button>
      </div>
      <hr>

      <ul class="tree">
        <% function render(nodes) { %>
          <% nodes.forEach(node=> { %>
            <li data-id="<%= node.id %>" class="<%= selectedFolderId === node.id ? 'selected' : '' %>">
              <% if (node.type==="FOLDER" ) { %>
                <div class="folder" tabindex="0" role="treeitem" aria-expanded="false" data-open="false">
                  <span class="icon" data-toggle>â–¶</span>
                  <a href="/?selectedFolder=<%= node.id %>" class="name idLink">
                    <%= node.name %>
                  </a>
                </div>

                <ul class="children" role="group">
                  <%= render(node.children) %>
                </ul>

                <% } else { %>
                  <div class="file" tabindex="0" role="treeitem" data-id="<%= node.id %>">
                    ðŸ“„
                    <a class="idLink" href="/?selectedFolder=<%= node.parentId %>&selectedFile=<%= node.id %>">
                      <%= node.name %>
                    </a>
                  </div>
                  <% } %>
            </li>
            <% }) %>
              <% } %>

                <%= render(tree) %>
      </ul>



    </aside>
    <section>
      <%- include('./partials/entityInfo', { entity: entity }) %>
    </section>
  </div>

  <%- include('./partials/popup') %>
</body>

<script src="/js/popup.js"></script>
<script>
  function highlightAndOpen(id) {
    if (!id) return;

    // Remove previous selection
    document.querySelectorAll(".selected").forEach(el => el.classList.remove("selected"));

    // Find the <li> for this id
    const selectedLi = document.querySelector(`li[data-id='${id}']`);
    if (!selectedLi) return;

    selectedLi.classList.add("selected");

    // Expand all parent folders, but leave toggle logic intact
    let parent = selectedLi.parentElement;
    while (parent && parent.classList.contains("children")) {
      const folder = parent.previousElementSibling;
      if (folder && folder.classList.contains("folder")) {
        const icon = folder.querySelector(".icon");
        folder.dataset.open = "true";
        folder.setAttribute("aria-expanded", "true");
        parent.style.display = "block";
        if (icon) icon.textContent = "â–¼";
      }
      parent = parent.parentElement.closest(".children");
    }

    // Scroll selected item into view
    selectedLi.scrollIntoView({ block: "nearest", behavior: "smooth" });
  }

  // Run on page load
  const selectedFolderId = "<%= selectedFolderId %>"; // from server
  const selectedFileId   = "<%= selectedFileId %>";   // optional

  if (selectedFolderId) highlightAndOpen(selectedFolderId);
  if (selectedFileId) highlightAndOpen(selectedFileId);

  // ---- Folder toggle (arrow only) ----
  document.querySelectorAll(".icon[data-toggle]").forEach(icon => {
    icon.addEventListener("click", e => {
      e.stopPropagation(); // only toggle this folder
      const folder = icon.closest(".folder");
      const children = folder.nextElementSibling;
      if (!children) return;

      const open = folder.dataset.open === "true";
      folder.dataset.open = String(!open);
      folder.setAttribute("aria-expanded", String(!open));
      children.style.display = open ? "none" : "block";
      icon.textContent = open ? "â–¶" : "â–¼";
    });

    // Keyboard support for arrow toggle
    icon.setAttribute("tabindex", "0");
    icon.addEventListener("keydown", e => {
      if (e.key !== "Enter" && e.key !== " ") return;
      e.preventDefault();
      icon.click();
    });
  });
</script>




</html>